(function(){function e(e){var t=e.naturalWidth,n=e.naturalHeight;if(t*n>1024*1024){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");i.drawImage(e,-t+1,0);return i.getImageData(0,0,1,1).data[3]===0}else{return false}}function t(e,t,n){var r=document.createElement("canvas");r.width=1;r.height=n;var i=r.getContext("2d");i.drawImage(e,0,0);var s=i.getImageData(0,0,1,n).data;var o=0;var u=n;var a=n;while(a>o){var f=s[(a-1)*4+3];if(f===0){u=a}else{o=a}a=u+o>>1}var l=a/n;return l===0?1:l}function n(e,t,n){var i=document.createElement("canvas");r(e,i,t,n);return i.toDataURL("image/jpeg",t.quality||.8)}function r(n,r,s,o){var u=n.naturalWidth,a=n.naturalHeight;var f=s.width,l=s.height;var c=r.getContext("2d");c.save();i(r,f,l,s.orientation);var h=e(n);if(h){u/=2;a/=2}var p=1024;var d=document.createElement("canvas");d.width=d.height=p;var v=d.getContext("2d");var m=o?t(n,u,a):1;var g=Math.ceil(p*f/u);var y=Math.ceil(p*l/a/m);var b=0;var w=0;while(b<a){var E=0;var S=0;while(E<u){v.clearRect(0,0,p,p);v.drawImage(n,-E,-b);c.drawImage(d,0,0,p,p,S,w,g,y);E+=p;S+=g}b+=p;w+=y}c.restore();d=v=null}function i(e,t,n,r){switch(r){case 5:case 6:case 7:case 8:e.width=n;e.height=t;break;default:e.width=t;e.height=n}var i=e.getContext("2d");switch(r){case 2:i.translate(t,0);i.scale(-1,1);break;case 3:i.translate(t,n);i.rotate(Math.PI);break;case 4:i.translate(0,n);i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI);i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI);i.translate(0,-n);break;case 7:i.rotate(.5*Math.PI);i.translate(t,-n);i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI);i.translate(-t,0);break;default:break}}function s(e){if(e instanceof Blob){var t=new Image;var n=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!n){throw Error("No createObjectURL function found to create blob url")}t.src=n.createObjectURL(e);this.blob=e;e=t}if(!e.naturalWidth&&!e.naturalHeight){var r=this;e.onload=function(){var e=r.imageLoadListeners;if(e){r.imageLoadListeners=null;for(var t=0,n=e.length;t<n;t++){e[t]()}}};this.imageLoadListeners=[]}this.srcImage=e}s.prototype.render=function(e,t){if(this.imageLoadListeners){var i=this;this.imageLoadListeners.push(function(){i.render(e,t)});return}t=t||{};var s=this.srcImage.naturalWidth,o=this.srcImage.naturalHeight,u=t.width,a=t.height,f=t.maxWidth,l=t.maxHeight,c=!this.blob||this.blob.type==="image/jpeg";if(u&&!a){a=o*u/s<<0}else if(a&&!u){u=s*a/o<<0}else{u=s;a=o}if(f&&u>f){u=f;a=o*u/s<<0}if(l&&a>l){a=l;u=s*a/o<<0}var h={width:u,height:a};for(var p in t)h[p]=t[p];var d=e.tagName.toLowerCase();if(d==="img"){e.src=n(this.srcImage,h,c)}else if(d==="canvas"){r(this.srcImage,e,h,c)}if(typeof this.onrender==="function"){this.onrender(e)}};if(typeof define==="function"&&define.amd){define([],function(){return s})}else{this.MegaPixImage=s}})();